# stm32f4

## RCC

리셋시 16MHz 내부 RC 오실레이터 동작. 이후 외부 클럭소스(4-26MHz)를 선택할 수 있고, failure를 모니터할 수 있다. failure 발생시 인터럽트(if enabled) 동작.

APB1 <= 42MHz <= APB2 <= 84MHz <= AHB <= 168MHz

### HSE

`RCC_CR` 레지스터의 HSERDY 비트가 셋되어야 해당 클럭을 사용가능. 하드웨어적으로 셋되며 인터럽트 발생가능(`RCC_CIR`).
on, off는 `RCC_CR`의 HSEON 비트.

### HSI

는 내부 16MHz RC 오실레이터에서 제공. 비용을 줄이고 빠른 스타트업 타임을 가지지만 캘리브레이션 하더라도 HSE보다 정확도가 낮다.
HSION비트와 HSERDY비트 역시 제공. 하지만 인터럽트는 지원하지 않음. HSE가 실패할 경우 백업용으로 사용 가능.

### PLL

두개의 PLL. 메인 PLL은 HSE또는 HSI 오실레이터로부터 클럭을 받는다. 1. 최대 168MHz high speed 시스템 클럭 생성. 2. USB OTG FS(48MHz), random analog generator(<=48MHz), SDIO(<= 48MHz) 생성

다른 하나의 PLL은 I2S 고성능 오디오 퍼포먼스를 위해 정확한 클럭을 생성

메인 PLL은 PLL이 인에블된 이후에는 설정 변경이 불가능하다. 1. 클럭 소스 설정 2. division factor 설정(M, N, P, Q)

PLLI2S는 PLL과(PLLM[5:0], PLLSRC) 동일한 입력 클럭 사용. 하지만 활성/비활성 그리고 division factor(N, R) 설정 가능.

stop, standby 모드 진입할 때와 HSE가 실패할 경우 PLL은 비활성화된다.

`RCC_PLLCFGR` 레지스터는 PLL설정, `RCC_CFGR` 레지스터는 PLLI2S 설정.

### LSE

32.768 RTC를 위한 외부 저속 클럭. `RCC_BDCR`에서 LSEON비트로 활성/비활성. LSERDY비트와 `RCC_CIR`레지스터의 LSE비트로 인터럽트 가능.

### LSI

IWDG와 AWU를 위한 내부 저전력 클럭. 약 32KHz. `RCC_CSR`레지스터의 LSION비트로 on/off. LSIRDY비트, `RCC_CIR`레지스터에서 인터럽트 설정가능. (LSI오실레이터는 비활성화될 수 없다고 와치독 부분에 언급)

리셋시 HSI가 시스템 클럭 소스로 설정됨.

### CSS

HSE 실패가 감지되면 TIM1, TIM8로 이벤트가 가고 NMI 인터럽트 발생. CSS 펜딩 비트를 소프트웨어적으로 클리어해주어야 함. HSI클럭으로 전환.

MCO1과 MC02 핀을 통해 클럭을 내보낼 수 있다. 1~5 프리스케일러를 사용할 수 있으며 I/O 최대 속도인 100MHz을 넘을 순 없다. 해당 핀은 alternate function 모드로 설정되어야 함.

```
RCC_PLLCFGR
PLLSRC 비트 셋
PLLM = 4(/M) ;8MHz/4=2MHz --> 8 ;8/8=1
PLLN = 336
PLLP = 0
PLLQ = 7

pull output = vco / pllp
vco = vcoi * plln
vcoi = input / pllm

pllm 8
plln 336
pllp 2

RCC_CFGR
RTCPRE = /8
PPRE2 = /2
PPRE1 = /4
HPRE  = 0
SW = 2

flash_acr 5ws(6cpu cycle)
what is VOS?
PRFTEN비트 FLASH_ACR 프리페치
ICEN, DCEN 캐시
```
